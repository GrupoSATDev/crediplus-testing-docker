import{b as w}from"./chunk-ZVLDBLLW.js";import{E as k,Nc as d,X as f,_ as T,ba as h,h as g,ha as u,l as a,q as p}from"./chunk-IEDNLM77.js";import{a as m}from"./chunk-NEB6MB4Y.js";var l=class{static isTokenExpired(t,r){if(!t||t==="")return!0;let e=this._getTokenExpirationDate(t);return r=r||0,e===null?!0:!(e.valueOf()>new Date().valueOf()+r*1e3)}static _b64decode(t){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e="";if(t=String(t).replace(/=+$/,""),t.length%4===1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let o=0,i,c,C=0;c=t.charAt(C++);~c&&(i=o%4?i*64+c:c,o++%4)?e+=String.fromCharCode(255&i>>(-2*o&6)):0)c=r.indexOf(c);return e}static _b64DecodeUnicode(t){return decodeURIComponent(Array.prototype.map.call(this._b64decode(t),r=>"%"+("00"+r.charCodeAt(0).toString(16)).slice(-2)).join(""))}static _urlBase64Decode(t){let r=t.replace(/-/g,"+").replace(/_/g,"/");switch(r.length%4){case 0:break;case 2:{r+="==";break}case 3:{r+="=";break}default:throw Error("Illegal base64url string!")}return this._b64DecodeUnicode(r)}static _decodeToken(t){if(!t)return null;let r=t.split(".");if(r.length!==3)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");let e=this._urlBase64Decode(r[1]);if(!e)throw new Error("Cannot decode the token.");return JSON.parse(e)}static _getTokenExpirationDate(t){let r=this._decodeToken(t);if(r.iat=new Date(r.iat),r.iat=Math.floor(r.iat.getTime()/1e4),!r.hasOwnProperty("exp"))return null;let e=new Date(0);return e.setUTCSeconds(r.exp),e.setUTCSeconds(r.exp),e}};var b=(()=>{let t=class t{constructor(){this._httpClient=u(d),this._user=new g(1)}set user(e){this._user.next(e)}get user$(){return this._user.asObservable()}get(){return this._httpClient.get("api/common/user").pipe(T(e=>{this._user.next(e)}))}update(e){return this._httpClient.patch("api/common/user",{user:e}).pipe(p(o=>{this._user.next(o)}))}};t.\u0275fac=function(o){return new(o||t)},t.\u0275prov=h({token:t,factory:t.\u0275fac,providedIn:"root"});let s=t;return s})();var n=class extends Error{};n.prototype.name="InvalidTokenError";function x(s){return decodeURIComponent(atob(s).replace(/(.)/g,(t,r)=>{let e=r.charCodeAt(0).toString(16).toUpperCase();return e.length<2&&(e="0"+e),"%"+e}))}function y(s){let t=s.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return x(t)}catch{return atob(t)}}function _(s,t){if(typeof s!="string")throw new n("Invalid token specified: must be a string");t||(t={});let r=t.header===!0?0:1,e=s.split(".")[r];if(typeof e!="string")throw new n(`Invalid token specified: missing part #${r+1}`);let o;try{o=y(e)}catch(i){throw new n(`Invalid token specified: invalid base64 for part #${r+1} (${i.message})`)}try{return JSON.parse(o)}catch(i){throw new n(`Invalid token specified: invalid json for part #${r+1} (${i.message})`)}}var H=(()=>{let t=class t{constructor(){this._authenticated=!1,this._httpClient=u(d),this._userService=u(b),this._appSettings=u(w)}set accessToken(e){localStorage.setItem("accessToken",e)}get accessToken(){return localStorage.getItem("accessToken")??""}forgotPassword(e){return this._httpClient.post("api/auth/forgot-password",e)}resetPassword(e){return this._httpClient.post("api/auth/reset-password",e)}signIn(e){return this._httpClient.post(this._appSettings.auth.url.base,e).pipe(p(o=>{let i={id:Math.random().toString(),name:o.data.nombre,email:o.data.correo,avatar:"images/avatars/avatar-user.png",status:"online"};return o.tokenType="bearer",o.user=m({},i),delete o.data,o}),f(o=>(this.accessToken=o.accessToken,this._authenticated=!0,this._userService.user=o.user,a(o))))}signInUsingToken(){return this._httpClient.post("api/auth/sign-in-with-token",{accessToken:this.accessToken}).pipe(k(()=>a(!1)),f(e=>(e.accessToken&&(this.accessToken=e.accessToken),this._authenticated=!0,this._userService.user=e.user,a(!0))))}signOut(){return localStorage.removeItem("accessToken"),this._authenticated=!1,a(!0)}signUp(e){return this._httpClient.post("api/auth/sign-up",e)}unlockSession(e){return this._httpClient.post("api/auth/unlock-session",e)}check(){return this._authenticated?a(!0):this.accessToken?l.isTokenExpired(this.accessToken)?a(!1):a(!0):a(!1)}decodeToken(){if(!this.accessToken)return null;try{return _(this.accessToken)}catch(e){return console.error("Error al decodificar el token",e),null}}getRole(){return this.decodeToken()?.["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"]||null}getTipoUsuario(){return this.decodeToken()?.TipoUsuario||null}hasRole(e){return this.getRole()===e}hasTipoUsuario(e){return this.getTipoUsuario()===e}};t.\u0275fac=function(o){return new(o||t)},t.\u0275prov=h({token:t,factory:t.\u0275fac,providedIn:"root"});let s=t;return s})();export{b as a,H as b};
