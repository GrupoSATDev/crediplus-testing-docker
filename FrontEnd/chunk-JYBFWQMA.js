import{e as V}from"./chunk-KAEQCOKJ.js";import{d as B}from"./chunk-C66ODKJP.js";import{a as J,c as N}from"./chunk-YKJB7XET.js";import{b as q}from"./chunk-2YYUDHRL.js";import{Ba as M,E as O,Ec as w,Fb as d,Gb as $,I as U,Ka as v,La as A,Pb as L,W as _,Z as b,aa as T,bb as E,fe as P,g as I,ga as c,h as D,ka as j,ke as H,l as a,m as R,mb as l,nb as u,ob as F,q as g,vb as S,z as k}from"./chunk-ODJKW74N.js";import{a as C}from"./chunk-NEB6MB4Y.js";var p=class{static isTokenExpired(t,r){if(!t||t==="")return!0;let e=this._getTokenExpirationDate(t);return r=r||0,e===null?!0:!(e.valueOf()>new Date().valueOf()+r*1e3)}static _b64decode(t){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e="";if(t=String(t).replace(/=+$/,""),t.length%4===1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let o=0,s,n,f=0;n=t.charAt(f++);~n&&(s=o%4?s*64+n:n,o++%4)?e+=String.fromCharCode(255&s>>(-2*o&6)):0)n=r.indexOf(n);return e}static _b64DecodeUnicode(t){return decodeURIComponent(Array.prototype.map.call(this._b64decode(t),r=>"%"+("00"+r.charCodeAt(0).toString(16)).slice(-2)).join(""))}static _urlBase64Decode(t){let r=t.replace(/-/g,"+").replace(/_/g,"/");switch(r.length%4){case 0:break;case 2:{r+="==";break}case 3:{r+="=";break}default:throw Error("Illegal base64url string!")}return this._b64DecodeUnicode(r)}static _decodeToken(t){if(!t)return null;let r=t.split(".");if(r.length!==3)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");let e=this._urlBase64Decode(r[1]);if(!e)throw new Error("Cannot decode the token.");return JSON.parse(e)}static _getTokenExpirationDate(t){let r=this._decodeToken(t);if(r.iat=new Date(r.iat),r.iat=Math.floor(r.iat.getTime()/1e4),!r.hasOwnProperty("exp"))return null;let e=new Date(0);return e.setUTCSeconds(r.exp),e.setUTCSeconds(r.exp),e}static getTokenExpirationTime(t){if(!t)return null;try{let r=JSON.parse(atob(t.split(".")[1]));return r.exp?new Date(r.exp*1e3):null}catch(r){return console.error("Error decoding token:",r),null}}};var z=(()=>{let t=class t{constructor(){this._httpClient=c(w),this._user=new D(1)}set user(e){this._user.next(e)}get user$(){return this._user.asObservable()}get(){return this._httpClient.get("api/common/user").pipe(b(e=>{this._user.next(e)}))}update(e){return this._httpClient.patch("api/common/user",{user:e}).pipe(g(o=>{this._user.next(o)}))}};t.\u0275fac=function(o){return new(o||t)},t.\u0275prov=T({token:t,factory:t.\u0275fac,providedIn:"root"});let i=t;return i})();var h=class extends Error{};h.prototype.name="InvalidTokenError";function X(i){return decodeURIComponent(atob(i).replace(/(.)/g,(t,r)=>{let e=r.charCodeAt(0).toString(16).toUpperCase();return e.length<2&&(e="0"+e),"%"+e}))}function Y(i){let t=i.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return X(t)}catch{return atob(t)}}function G(i,t){if(typeof i!="string")throw new h("Invalid token specified: must be a string");t||(t={});let r=t.header===!0?0:1,e=i.split(".")[r];if(typeof e!="string")throw new h(`Invalid token specified: missing part #${r+1}`);let o;try{o=Y(e)}catch(s){throw new h(`Invalid token specified: invalid base64 for part #${r+1} (${s.message})`)}try{return JSON.parse(o)}catch(s){throw new h(`Invalid token specified: invalid json for part #${r+1} (${s.message})`)}}var K=(()=>{let t=class t{constructor(e){this.dialogRef=e,this.countDown=30,k(1e3).pipe(U(30)).subscribe(o=>{this.countDown=29-o,this.countDown===0&&this.dialogRef.close(!1)})}onRenew(){this.dialogRef.close(!0)}onLogout(){this.dialogRef.close(!1)}};t.\u0275fac=function(o){return new(o||t)(A(J))},t.\u0275cmp=j({type:t,selectors:[["app-tokenrenewaldialog"]],standalone:!0,features:[L],decls:17,vars:3,consts:[[1,"relative","flex","h-full","w-full","flex-col"],[1,"flex","flex-auto","flex-col","items-center","pb-6","sm:flex-row","sm:items-start","sm:pb-8"],[1,"flex","h-10","w-10","flex-0","items-center","justify-center","rounded-full","sm:mr-4","bg-blue-100","text-blue-600","dark:bg-blue-600","dark:text-blue-50"],[3,"svgIcon"],[1,"flex","flex-col","items-center","space-y-1","text-center","sm:mt-0","sm:items-start","sm:pr-8","sm:text-left"],[1,"text-xl","font-medium","leading-6"],[1,"text-secondary"],[1,"flex","items-center","justify-center","space-x-3","bg-gray-50","py-4","dark:bg-black","dark:bg-opacity-10","sm:justify-end"],["mat-flat-button","",1,"sm:w-auto","w-full","bg-crediblue-50","hover:bg-crediblue-100","text-white","font-semibold","py-2","px-4","rounded-lg","transition","duration-200",3,"click","color"],["mat-stroked-button","",1,"sm:w-auto","w-full","bg-crediorange-100","rounded-lg","transition","duration-200","text-white","font-semibold",3,"click"]],template:function(o,s){o&1&&(l(0,"div",0)(1,"div",1)(2,"div",2),F(3,"mat-icon",3),u(),l(4,"div",4)(5,"h2",5),d(6,"Tu sesi\xF3n est\xE1 por expirar"),u(),l(7,"p",6),d(8,"Tu sesi\xF3n expirar\xE1 en "),l(9,"strong"),d(10),u(),d(11," segundos."),u()()(),l(12,"div",7)(13,"button",8),S("click",function(){return s.onRenew()}),d(14," Extender "),u(),l(15,"button",9),S("click",function(){return s.onLogout()}),d(16," Cerrar sesi\xF3n "),u()()()),o&2&&(v(3),E("svgIcon","heroicons_solid:question-mark-circle"),v(7),$(s.countDown),v(3),E("color","primary"))},dependencies:[P,H]});let i=t;return i})();var _e=(()=>{let t=class t{constructor(){this._authenticated=!1,this._httpClient=c(w),this._userService=c(z),this._appSettings=c(q),this.aesEncriptService=c(V),this.destroyedRef=c(M),this.matDialog=c(N),this.router=c(B),this._tokenExpirationSubject=new I(!1),this.restoreSession(),this.checkTokenExpiration()}restoreSession(){if(!this.accessToken||!this.accessRefreshToken){this.signOut();return}p.isTokenExpired(this.accessToken)?(console.log("Token expirado, intentando renovar..."),this.signInUsingToken().subscribe(e=>{e?(console.log("Token renovado exitosamente."),this._authenticated=!0):(console.log("No se pudo renovar el token, cerrando sesi\xF3n..."),this.signOut())})):(console.log("Token v\xE1lido, restaurando sesi\xF3n..."),this._authenticated=!0)}set accessToken(e){localStorage.setItem("accessToken",e)}set refreshToken(e){localStorage.setItem("refreshToken",e)}get accessToken(){return localStorage.getItem("accessToken")??""}get accessRefreshToken(){return localStorage.getItem("refreshToken")??""}forgotPassword(e){return this._httpClient.post(`${this._appSettings.auth.url.baseReset}?email=${e}`,{})}resetPassword(e){return this._httpClient.post(this._appSettings.auth.url.baseChange,e)}signIn(e){let o={correo:e.correo,contrasena:e.contrasena},s={login:this.aesEncriptService.encryptObject(o)};return this._authenticated?R("User is already logged in."):this._httpClient.post(this._appSettings.auth.url.base,s).pipe(g(n=>{let f={id:Math.random().toString(),name:n.data.nombre,email:n.data.correo,avatar:"images/avatars/avatar-user.png",status:"online"};return n.tokenType="bearer",n.user=C({},f),delete n.data,n}),_(n=>(this.accessToken=n.accessToken,this.refreshToken=n.refreshToken,this._authenticated=!0,this._userService.user=n.user,a(n))))}signInUsingToken(){let e=this.accessToken,o=this.accessRefreshToken;return!e||!o?(this.signOut(),a(!1)):(console.log("Verificando token con API..."),this._httpClient.post(this._appSettings.auth.url.baseRefresh,{token:e,refreshToken:o}).pipe(O(s=>(this.signOut(),a(!1))),_(s=>s.token?(this.accessToken=s.token,this.refreshToken=s.refreshToken,this._authenticated=!0,a(!0)):(this.signOut(),a(!1)))))}checkTokenExpiration(){let e=!0,o=3e5,s=6e4,n=()=>{e=!1,setTimeout(()=>{e=!0},o)};["mousemove","keydown","scroll","click","touchstart"].forEach(m=>{window.addEventListener(m,n)}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?e=!0:n()}),window.addEventListener("blur",()=>{e=!0}),window.addEventListener("focus",n),k(1e4).pipe(b(()=>{let m=this.accessToken,Q=this.accessRefreshToken;if(!m||!Q){this.signOut();return}let x=p.getTokenExpirationTime(m)-Date.now();x>0&&x<=s?e||this.signInUsingToken().subscribe({next:y=>{y?console.log("Token renovado autom\xE1ticamente"):(console.error("Error renovando el token"),this.signOut())},error:y=>{console.error("Error renovando el token:",y),this.signOut()}}):x<=0&&(e?this.signOut():this.signOut())})).subscribe()}openTokenRenewalDialog(){this.matDialog.open(K,{width:"400px",disableClose:!0}).afterClosed().subscribe(o=>{o?this.signInUsingToken().subscribe():(this.signOut(),this.router.navigate(["/sign-in"]))})}logoutSession(){return this._httpClient.post(this._appSettings.auth.url.baseOut,{})}signOut(){return console.log("Cerrando sesi\xF3n..."),localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken"),this._authenticated=!1,this._userService.user=null,a(!0)}signUp(e){return this._httpClient.post("api/auth/sign-up",e)}unlockSession(e){return this._httpClient.post("api/auth/unlock-session",e)}check(){return this._authenticated?a(!0):this.accessToken?p.isTokenExpired(this.accessToken)?a(!1):this.signInUsingToken():a(!1)}decodeToken(){if(!this.accessToken)return null;try{return G(this.accessToken)}catch(e){return console.error("Error al decodificar el token",e),null}}getRole(){return this.decodeToken()?.["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"]||null}getTipoUsuario(){return this.decodeToken()?.TipoUsuario||null}hasRole(e){return this.getRole()===e}hasTipoUsuario(e){return this.getTipoUsuario()===e}};t.\u0275fac=function(o){return new(o||t)},t.\u0275prov=T({token:t,factory:t.\u0275fac,providedIn:"root"});let i=t;return i})();export{p as a,z as b,_e as c};
