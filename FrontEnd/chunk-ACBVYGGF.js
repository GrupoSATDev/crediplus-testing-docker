import{e as C}from"./chunk-234L6G73.js";import{b as _}from"./chunk-6KZCN3UQ.js";import{E as T,Ea as w,Nc as d,X as m,_ as b,ba as h,h as k,ha as c,l as a,q as p}from"./chunk-IEDNLM77.js";import{a as g}from"./chunk-NEB6MB4Y.js";var l=class{static isTokenExpired(t,r){if(!t||t==="")return!0;let e=this._getTokenExpirationDate(t);return r=r||0,e===null?!0:!(e.valueOf()>new Date().valueOf()+r*1e3)}static _b64decode(t){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e="";if(t=String(t).replace(/=+$/,""),t.length%4===1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let i=0,n,o,f=0;o=t.charAt(f++);~o&&(n=i%4?n*64+o:o,i++%4)?e+=String.fromCharCode(255&n>>(-2*i&6)):0)o=r.indexOf(o);return e}static _b64DecodeUnicode(t){return decodeURIComponent(Array.prototype.map.call(this._b64decode(t),r=>"%"+("00"+r.charCodeAt(0).toString(16)).slice(-2)).join(""))}static _urlBase64Decode(t){let r=t.replace(/-/g,"+").replace(/_/g,"/");switch(r.length%4){case 0:break;case 2:{r+="==";break}case 3:{r+="=";break}default:throw Error("Illegal base64url string!")}return this._b64DecodeUnicode(r)}static _decodeToken(t){if(!t)return null;let r=t.split(".");if(r.length!==3)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");let e=this._urlBase64Decode(r[1]);if(!e)throw new Error("Cannot decode the token.");return JSON.parse(e)}static _getTokenExpirationDate(t){let r=this._decodeToken(t);if(r.iat=new Date(r.iat),r.iat=Math.floor(r.iat.getTime()/1e4),!r.hasOwnProperty("exp"))return null;let e=new Date(0);return e.setUTCSeconds(r.exp),e.setUTCSeconds(r.exp),e}};var v=(()=>{let t=class t{constructor(){this._httpClient=c(d),this._user=new k(1)}set user(e){this._user.next(e)}get user$(){return this._user.asObservable()}get(){return this._httpClient.get("api/common/user").pipe(b(e=>{this._user.next(e)}))}update(e){return this._httpClient.patch("api/common/user",{user:e}).pipe(p(i=>{this._user.next(i)}))}};t.\u0275fac=function(i){return new(i||t)},t.\u0275prov=h({token:t,factory:t.\u0275fac,providedIn:"root"});let s=t;return s})();var u=class extends Error{};u.prototype.name="InvalidTokenError";function x(s){return decodeURIComponent(atob(s).replace(/(.)/g,(t,r)=>{let e=r.charCodeAt(0).toString(16).toUpperCase();return e.length<2&&(e="0"+e),"%"+e}))}function I(s){let t=s.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return x(t)}catch{return atob(t)}}function y(s,t){if(typeof s!="string")throw new u("Invalid token specified: must be a string");t||(t={});let r=t.header===!0?0:1,e=s.split(".")[r];if(typeof e!="string")throw new u(`Invalid token specified: missing part #${r+1}`);let i;try{i=I(e)}catch(n){throw new u(`Invalid token specified: invalid base64 for part #${r+1} (${n.message})`)}try{return JSON.parse(i)}catch(n){throw new u(`Invalid token specified: invalid json for part #${r+1} (${n.message})`)}}var q=(()=>{let t=class t{constructor(){this._authenticated=!1,this._httpClient=c(d),this._userService=c(v),this._appSettings=c(_),this.aesEncriptService=c(C),this.destroyedRef=c(w)}set accessToken(e){localStorage.setItem("accessToken",e)}get accessToken(){return localStorage.getItem("accessToken")??""}forgotPassword(e){return this._httpClient.post("api/auth/forgot-password",e)}resetPassword(e){return this._httpClient.post("api/auth/reset-password",e)}signIn(e){let i={correo:e.correo,contrasena:e.contrasena},n={login:this.aesEncriptService.encryptObject(i)};return this._httpClient.post(this._appSettings.auth.url.base,n).pipe(p(o=>{let f={id:Math.random().toString(),name:o.data.nombre,email:o.data.correo,avatar:"images/avatars/avatar-user.png",status:"online"};return o.tokenType="bearer",o.user=g({},f),delete o.data,o}),m(o=>(this.accessToken=o.accessToken,this._authenticated=!0,this._userService.user=o.user,a(o))))}signInUsingToken(){return this._httpClient.post("api/auth/sign-in-with-token",{accessToken:this.accessToken}).pipe(T(()=>a(!1)),m(e=>(e.accessToken&&(this.accessToken=e.accessToken),this._authenticated=!0,this._userService.user=e.user,a(!0))))}logoutSession(){return this._httpClient.post(this._appSettings.auth.url.baseOut,{})}signOut(){return localStorage.removeItem("accessToken"),this._authenticated=!1,a(!0)}signUp(e){return this._httpClient.post("api/auth/sign-up",e)}unlockSession(e){return this._httpClient.post("api/auth/unlock-session",e)}check(){return this._authenticated?a(!0):this.accessToken?l.isTokenExpired(this.accessToken)?a(!1):a(!0):a(!1)}decodeToken(){if(!this.accessToken)return null;try{return y(this.accessToken)}catch(e){return console.error("Error al decodificar el token",e),null}}getRole(){return this.decodeToken()?.["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"]||null}getTipoUsuario(){return this.decodeToken()?.TipoUsuario||null}hasRole(e){return this.getRole()===e}hasTipoUsuario(e){return this.getTipoUsuario()===e}};t.\u0275fac=function(i){return new(i||t)},t.\u0275prov=h({token:t,factory:t.\u0275fac,providedIn:"root"});let s=t;return s})();export{v as a,q as b};
